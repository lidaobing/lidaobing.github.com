---
layout: post
name: ioc
title: "[笔记]从工厂模式到IoC容器"
date: 2008-12-14 16:06:00.000000000 +08:00
tags: java spring ioc
permalink: /2008/12/ioc.html
---
<span style="font-size:85%;"><a id="_1__19434482623666838" name="_1__19434482623666838"></a> 1. 通过<span style="font-family:Courier New;">数据层访问数据库 </span></span><br /></h3><br /><span style="font-size:85%;">最简单的模型，采用一个数据访问层，来隔离应用与数据库。</span><br /><blockquote>  <span style="font-size:85%;"><span style="font-family:Courier New;">public class MyDA {</span><br /> <span style="font-family:Courier New;">  //...</span><br /> <span style="font-family:Courier New;">}</span><br /> <br /> <span style="font-family:Courier New;">public class MyApp {</span><br /> <span style="font-family:Courier New;">  public MyApp() {</span><br /> <span style="font-family:Courier New;">    da = new MyDA();</span><br /> <span style="font-family:Courier New;">  }</span><br /> <span style="font-family:Courier New;">  private MyDA da;</span><br /> <span style="font-family:Courier New;">  //...</span><br /> <span style="font-family:Courier New;">}</span></span><br /></blockquote><h3>  <span style="font-size:85%;"><a id="_2_Mock__9100267003033699" name="_2_Mock__9100267003033699"></a> 2. 面向界面编程，同时方便使用 Mock 方法测试</span><br /></h3><blockquote>  <span style="font-size:85%;"><span style="font-family:Courier New;"><b>public interface IMyDA {<br />   //...<br /> }</b><br /><br /> public class MyDA <b>implements IMyDA</b> {</span><br /> <span style="font-family:Courier New;">  //...</span><br /> <span style="font-family:Courier New;">}</span><br /> <br /> <span style="font-family:Courier New;">public class MyApp {</span><br /> <span style="font-family:Courier New;">  public MyApp() {</span><br /> <b><span style="font-family:Courier New;">    setDA(new MyDA());</span></b><span style="font-family:Courier New;"></span><br /> <span style="font-family:Courier New;">  }<br /> <b>  protected void setDA(IMyDA da) {<br />     this.da = da;<br />   }<br /> </b></span><span style="font-family:Courier New;">  private <b>IMyDA</b> da;</span><br /> <span style="font-family:Courier New;">  //...</span><br /> <span style="font-family:Courier New;">}</span><br /><br /> </span><br /></blockquote><br /><span style="font-size:85%;"> 关于 Mock 测试，参见 <a href="http://www.ibm.com/developerworks/library/j-mocktest.html" id="fl4." title="http://www.ibm.com/developerworks/library/j-mocktest.html">http://www.ibm.com/developerworks/library/j-mocktest.html</a></span><br /><h3>  <span style="font-size:85%;"><a id="_3__3387658176464674" name="_3__3387658176464674"></a> 3. 引入工厂模式，隔离数据访问与业务逻辑<br /><br /> </span><br /></h3><br /><blockquote><br /> <span style="font-size:85%;"><span style="font-family:Courier New;">public interface IMyDA {</span><br /> <span style="font-family:Courier New;">   //...</span><br /> <span style="font-family:Courier New;"> }</span><br /><br /> <span style="font-family:Courier New;"> public class MyDA implements IMyDA {</span><br /> <span style="font-family:Courier New;">  //...</span><br /> <span style="font-family:Courier New;">}</span><b><br /><br /> </b><span style="font-family:Courier New;"><b>public class MyDAFactory {<br />   public IMyDA createMyDA(String name) {<br />     if(name.equals("foo")) {<br />       return new MyDA();<br />     } else {<br />       throw new Exception();<br />     }<br />   }<br /> }</b><br /> </span><br /> <span style="font-family:Courier New;">public class MyApp {</span><br /> <span style="font-family:Courier New;">  public MyApp() {</span><br /> <span style="font-family:Courier New;">    setDA(</span><span style="font-family:Courier New;"><b>MyDAFactory.createMyDA("foo")</b></span><span style="font-family:Courier New;">);</span><span style="font-family:Courier New;"></span><br /> <span style="font-family:Courier New;">  }</span><br /> <span style="font-family:Courier New;">   protected void setDA(IMyDA da) {</span><br /> <span style="font-family:Courier New;">     this.da = da;</span><br /> <span style="font-family:Courier New;">   }</span><br /> <span style="font-family:Courier New;"> </span><span style="font-family:Courier New;">  private IMyDA da;</span><br /> <span style="font-family:Courier New;">  //...</span><br /> <span style="font-family:Courier New;">}</span><br /><br /> </span><br /></blockquote><br /><span style="font-size:85%;"> 这种情况下 MyApp 仍然通过 MyDAFactory 来依赖与 MyDA, 甚至各种 IMyDA 的实现。另外，工厂模式不方便添加新的实现。<br /><br /></span><br /><h3><br /> <span style="font-size:85%;"><a id="_4_IoC__6907588530215318" name="_4_IoC__6907588530215318"></a> 4. 引入 IoC 容器 </span><br /></h3><br /><span style="font-size:85%;">Java 源码部分<br /><br /></span><br /><blockquote><br /> <span style="font-size:85%;"><span style="font-family:Courier New;">public interface IMyDA {</span><br /><span style="font-family:Courier New;">  //...</span><br /> <span style="font-family:Courier New;"> }</span><br /><br /> <span style="font-family:Courier New;"> public class MyDA implements IMyDA {</span><br /> <span style="font-family:Courier New;">  //...</span><br /> <span style="font-family:Courier New;">}</span><br /><br /> <br /> <span style="font-family:Courier New;"></span><span style="font-family:Courier New;">public class MyApp {</span><br /> <span style="font-family:Courier New;">  public MyApp() {    </span><br /> <span style="font-family:Courier New;">    BeanFactory factory = new XmlBeanFactory(</span><span style="font-family:Courier New;"><br />         new FileInputStream("myapp.xml"));</span><span style="font-family:Courier New;"><br />     da = (IMyDA) factory.getBean("da");<br />   }<br /><br />   private IMyDA da;</span><br /> <span style="font-family:Courier New;">  //...</span><br /> <span style="font-family:Courier New;">}</span></span><br /></blockquote><span style="font-size:85%;"> 用到的 myapp.xml 文件</span><br /><blockquote>  <span style="font-size:85%;"><span style="font-family:Courier New;">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br /> <span style="font-family:Courier New;">&lt;beans xmlns="http://www.springframework.org/schema/beans"</span><br /> <span style="font-family:Courier New;"> xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span><br /> <span style="font-family:Courier New;"> xsi:schemaLocation="</span><br /> <span style="font-family:Courier New;">http://www.springframework.org/schema/beans</span><br /> <span style="font-family:Courier New;">http://www.springframework.org/schema/beans/spring-beans-2.0.xsd"&gt;</span><br /> <span style="font-family:Courier New;"> &lt;bean id="da" class="MyDA"/&gt;</span><br /> <span style="font-family:Courier New;">&lt;/beans&gt;</span></span><br /></blockquote><h3>  <span style="font-size:85%;"><a id="5_" name="5_"></a>5. 一个复杂点的例子</span><br /></h3><br /><span style="font-size:85%;">上面的例子有点小题大做了，在真实的环境中，数据访问一般需要通过 MySQL库, 连接池, cache, 甚至更多的层，每一层都需要可以配置，最好也支持替换(方便测试)，设置还需要支持删除某些中间层，工厂模式用于这样的情形则非常麻烦，但是 IoC 处理这样的情形则比较简单，比如把如下的文件替换掉上面的myapp.xml，那么你的应用的数据访问层就变成了用于数据库连接池和cache功能的 SuperMyDA。<br /><br /><br /><br />更重要的是，隔离非常彻底，在你编写编译 MyApp 的时候，你根本就用不着 proxool, memcache 这类组件。<br /><br /><br /><br />注意: 下面文件里面的内容都是乱写的，我还没去查这些组件的接口, :-)<br /><br /></span><br /><blockquote><br /> <span style="font-size:85%;"><span style="font-family:Courier New;">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br /> <span style="font-family:Courier New;">&lt;beans xmlns="http://www.springframework.org/schema/beans"</span><br /> <span style="font-family:Courier New;"> xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span><br /> <span style="font-family:Courier New;"> xsi:schemaLocation="</span><br /> <span style="font-family:Courier New;">http://www.springframework.org/schema/beans</span><br /> <span style="font-family:Courier New;">http://www.springframework.org/schema/beans/spring-beans-2.0.xsd"&gt;<br /><br /> &lt;!-- 配置 mysql 连接 --&gt;<br /> </span><span style="font-family:Courier New;">&lt;bean id="db" class="com.mysql.Connection"&gt;<br />   &lt;property name="uri"<br />     value="mysql://userName:secret@192.168.12.23/dbname"/&gt;<br /> &lt;/bean&gt;<br /><br /> &lt;!-- 配置 proxool --&gt;<br /> &lt;bean id="proxool" class="com.proxool.Pool"&gt;<br />   &lt;property name="db" ref="db"/&gt;<br />   &lt;property name="maxConnection" value="200"/&gt;<br /> &lt;/bean&gt;<br /><br /> &lt;!-- 配置 memcache --&gt;<br /> &lt;bean id="memcache" class="com.memcache.Foo"&gt;<br />   &lt;property name="config" value="192.168.23.34:12345"&gt;<br /> &lt;/bean&gt;<br /><br />&lt;!-- 配置 SuperMyDA --&gt;<br /> &lt;bean id="da" class="SuperMyDA"&gt;<br />   &lt;property name="proxool" ref="proxool"/&gt;<br />   &lt;property name="memcache" ref="memcache"/&gt;<br /> &lt;/bean&gt;</span><br /> <span style="font-family:Courier New;">&lt;/beans&gt;</span></span></blockquote><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/6324560-8042547869255344128?l=lidaobing.blogspot.com' alt='' /></div>
