---
layout: post
name: tomcat-https
title: tomcat 部署 https
date: 2010-02-04 16:25:00.000000000 +08:00
categories: []
permalink: /2010/02/tomcat-https.html
---
<h1>tomcat 部署 https</h1><br /><div><ol><li>在 startssl 上<a id="wy8q" href="https://www.startssl.com/?app=12" title="申请认证">申请认证</a>, 最后你会得到两个文件: ssl.key 和 ssl.crt, 建立一个新目录, 把这两个文件拷贝到该目录<br></li><li>下载 https://www.startssl.com/certs/ca.pem 和 https://www.startssl.com/certs/sub.class1.server.ca.pem</li><li>运行<br>cat ssl.crt ca.pem sub.class1.server.ca.pem &gt; chain.crt</li><li>运行<br>openssl pkcs12 -export -in chain.crt -inkey ssl.key -out keystore.pkcs12 -name tomcat<br>使用密码 "PASSWORD"</li><li>运行 (可选, 该步为校验步骤)<br>keytool -list -rfc -keystore keystore.pkcs12 -storetype pkcs12<br><b>注意:&nbsp;</b>结果中要含有如下的一行 "Certificate chain length: 3"</li><li>运行<br>keytool -importkeystore -srckeystore keystore.pkcs12 \<br>-srcstoretype PKCS12 -destkeystore keystore \<br>-srcalias tomcat -destkeypass PASSWORD<br>(<b>注意:</b> 此处的 PASSWORD 需要与目标 store 的密码一致)&nbsp;</li><li>运行<br>cp keystore $TOMCAT_HOME/conf/</li><li>修改 $TOMCAT_HOME/conf/server.xml, 去掉 SSL Connector 附近的注释, 内容如下:<br><span style="font-family: Arial, Verdana, sans-serif"><font class="Apple-style-span" face="Verdana">&lt;Connector URIEncoding="UTF-8" port="443" protocol="HTTP/1.1" SSLEnabled="true"<br></font><font class="Apple-style-span" face="Verdana">maxThreads="150" scheme="https" secure="true"<br></font><font class="Apple-style-span" face="Verdana">clientAuth="false" sslProtocol="TLS" <br></font><font class="Apple-style-span" face="Verdana">keystoreFile="conf/keystore"<br></font><font class="Apple-style-span" face="Verdana">keystorePass="********"<br></font><font class="Apple-style-span" face="Verdana">keyAlias="tomcat"<br></font><font class="Apple-style-span" face="Verdana">/&gt;</font></span></li><li><span style="font-family: Arial, Verdana, sans-serif"><font class="Apple-style-span" face="Verdana"><span style="font-family: Arial, Verdana, sans-serif">把其余的 redirectPort="8443" 改为 redirectPort="443"</span></font></span></li><li><span style="font-family: Arial, Verdana, sans-serif"><font class="Apple-style-span" face="Verdana">重启 tomcat</font></span></li><li><span style="font-family: Arial, Verdana, sans-serif"><font class="Apple-style-span" face="Verdana"><span style="font-family: Arial, Verdana, sans-serif">调整防火墙，启用 443 端口</span></font></span></li><li>备份 ssl.key 和 ssl.crt 到安全位置, 删除整个目录, 设置 $TOMCAT/conf/keystore 的属主为 tomcat 的运行用户, 设置权限为 640 或更低权限</li></ol><div><br></div><div>注意事项:<br><ol><li>ssl.crt ca.pem sub.class1.server.ca.pem 都必须是 PEM 格式 (看起来类似base64)</li><li>所有步骤中建议使用同一套密码</li><li>此处对密码的要求不是很高, 因为运营机器上的 root 用户能同时拿到 keystore 和 server.xml, 密码再复杂也无效, 非 root 用户拿不到 keystore, 所以是安全的</li><li>如果有更高的安全要求, 建议修改 tomcat 的启动脚本, 在启动时手动输入密码, 设置为环境变量, 然后在 server.xml 中使用环境变量来获得密码 (仍然有问题, root 不在自己手上, 安全经常是幻像)</li><li>Firefox, Chrome, IE 下均不会报警, 但 Java 客户端仍然不能使用, 解决方法如下</li><ol><li>运行: wget https://www.startssl.com/certs/ca.pem</li><li>运行: keytool -importcert -trustcacerts -file ca.pem -keystore foo -storepass changeit</li><li>把 foo 拷贝到你的程序中</li><li><div>把如下两行代码加到你的程序 main 函数中:<br>System.setProperty("javax.net.ssl.trustStore", "/path/to/foo");<br>System.setProperty("javax.net.ssl.trustStorePassword", "changeit");</div><div><br></div><div><br></div><div><br></div></li></ol></ol></div></div><br><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/6324560-935051461365761190?l=lidaobing.blogspot.com' alt='' /></div>
